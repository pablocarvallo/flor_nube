<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flor Finanzas</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flor">
    
    <link rel="apple-touch-icon" href="polla.png">
    <link rel="icon" type="image/png" href="polla.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #F2F2F7;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .ios-btn { transition: transform 0.1s ease, opacity 0.2s; }
        .ios-btn:active { transform: scale(0.96); opacity: 0.8; }
        .ios-input {
            background-color: #FFFFFF;
            border-radius: 12px;
            padding: 16px;
            font-size: 17px;
            border: 1px solid #E5E5EA;
            width: 100%;
            outline: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDK61HCOgOis2LeFdbISwZKat-sGi_vCUs",
            authDomain: "flor-finanzas.firebaseapp.com",
            projectId: "flor-finanzas",
            storageBucket: "flor-finanzas.firebasestorage.app",
            messagingSenderId: "804088146248",
            appId: "1:804088146248:web:e743abd6a8a57925ad6b7d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.firebaseDoc = doc;
        window.firebaseOnSnapshot = onSnapshot;
        window.firebaseSetDoc = setDoc;
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const WalletIcon = () => <span>üí∞</span>;
        const CreditCardIcon = () => <span>üí≥</span>;
        const CalendarIcon = () => <span>üóìÔ∏è</span>;
        const TrashIcon = () => <span>üóëÔ∏è</span>;
        const XIcon = () => <span>‚úñÔ∏è</span>;
        const CheckIcon = () => <span>‚úÖ</span>;

        const formatCurrency = (amount) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(amount);
        
        const getNextMonthYear = () => {
            const date = new Date();
            date.setMonth(date.getMonth() + 1);
            const options = { month: 'long', year: 'numeric' };
            let formatted = date.toLocaleDateString('es-ES', options);
            formatted = formatted.replace(/ de /g, ' ');
            return formatted.charAt(0).toUpperCase() + formatted.slice(1);
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('settlement');
            const [showReport, setShowReport] = useState(false);
            const [loading, setLoading] = useState(true);
            const [transactions, setTransactions] = useState([]);
            const [debtBalance, setDebtBalance] = useState(0);
            const [initialDebt, setInitialDebt] = useState(0);
            const [installments, setInstallments] = useState([]);
            const [amount, setAmount] = useState('');
            const [detail, setDetail] = useState('');
            const [account, setAccount] = useState('Ita√∫');
            const [debtPayment, setDebtPayment] = useState('');
            const [debtDetail, setDebtDetail] = useState('');
            const [initialDebtInput, setInitialDebtInput] = useState('');
            const [isSettingDebt, setIsSettingDebt] = useState(false);
            const [instAmount, setInstAmount] = useState('');
            const [instDetail, setInstDetail] = useState('');
            const [instTotal, setInstTotal] = useState('');
            const [instPaid, setInstPaid] = useState('');

            useEffect(() => {
                const docRef = window.firebaseDoc(window.db, "finanzas", "datos_globales");
                const unsub = window.firebaseOnSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setTransactions(data.transactions || []);
                        setDebtBalance(data.debtBalance || 0);
                        setInitialDebt(data.initialDebt || 0);
                        setInstallments(data.installments || []);
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            const sync = async (update) => {
                const docRef = window.firebaseDoc(window.db, "finanzas", "datos_globales");
                await window.firebaseSetDoc(docRef, {
                    transactions: update.transactions !== undefined ? update.transactions : transactions,
                    debtBalance: update.debtBalance !== undefined ? update.debtBalance : debtBalance,
                    initialDebt: update.initialDebt !== undefined ? update.initialDebt : initialDebt,
                    installments: update.installments !== undefined ? update.installments : installments
                }, { merge: true });
            };

            const addTransaction = () => {
                if (!amount || !detail) return;
                const newT = { id: Date.now(), date: new Date().toISOString(), amount: parseInt(amount), detail, account, type: 'normal' };
                const newList = [...transactions, newT];
                setTransactions(newList);
                sync({ transactions: newList });
                setAmount(''); setDetail('');
            };

            const deleteTransaction = (id) => {
                if(!confirm('¬øEliminar registro?')) return;
                const tToDelete = transactions.find(t => t.id === id);
                let newDebtBalance = debtBalance;
                if (tToDelete && tToDelete.type === 'debt') { newDebtBalance += tToDelete.amount; }
                const newList = transactions.filter(t => t.id !== id);
                setTransactions(newList);
                setDebtBalance(newDebtBalance);
                sync({ transactions: newList, debtBalance: newDebtBalance });
            };

            const payDebt = () => {
                if (!debtPayment || !debtDetail) return;
                const payVal = parseInt(debtPayment);
                const newBal = debtBalance - payVal;
                const newT = { id: Date.now(), date: new Date().toISOString(), amount: payVal, detail: debtDetail, account: 'BCH', type: 'debt', remainingSnapshot: newBal };
                const newList = [...transactions, newT];
                setTransactions(newList);
                setDebtBalance(newBal);
                sync({ transactions: newList, debtBalance: newBal });
                setDebtPayment(''); setDebtDetail('');
            };

            const payInstallmentQuota = (id) => {
                const updatedInst = installments.map(item => {
                    if (item.id === id && item.currentQuota < item.totalQuotas) {
                        const nextQuota = item.currentQuota + 1;
                        const newT = { 
                            id: Date.now(), 
                            date: new Date().toISOString(), 
                            amount: item.amount, 
                            detail: `${item.detail} (Cuota ${nextQuota}/${item.totalQuotas})`, 
                            account: 'Ita√∫', 
                            type: 'normal' 
                        };
                        const newList = [...transactions, newT];
                        setTransactions(newList);
                        sync({ transactions: newList });
                        return { ...item, currentQuota: nextQuota, active: nextQuota < item.totalQuotas };
                    }
                    return item;
                });
                setInstallments(updatedInst);
                sync({ installments: updatedInst });
            };

            const deleteInstallmentDebt = (id) => {
                if(!confirm('¬øEliminar esta deuda de la lista?')) return;
                const newList = installments.filter(i => i.id !== id);
                setInstallments(newList);
                sync({ installments: newList });
            };

            const shareAsImage = async () => {
                const reportElement = document.getElementById('report-container');
                if (!reportElement) return;
                try {
                    const canvas = await html2canvas(reportElement, { 
                        scale: 3,
                        backgroundColor: "#FFFFFF",
                        useCORS: true,
                        // A√±adimos margen extra en la captura para evitar recortes
                        x: -20,
                        y: -20,
                        width: reportElement.offsetWidth + 40,
                        height: reportElement.offsetHeight + 40
                    });
                    canvas.toBlob(async (blob) => {
                        const file = new File([blob], `Reporte_${getNextMonthYear()}.png`, { type: 'image/png' });
                        if (navigator.share) {
                            await navigator.share({
                                files: [file],
                                title: `Reporte ${getNextMonthYear()}`
                            });
                        }
                    });
                } catch (err) {
                    alert('Error al generar la imagen');
                }
            };

            const shareAsText = async () => {
                let text = `REPORTE ${getNextMonthYear().toUpperCase()}\n`;
                text += `============================\n\n`;
                if (itauTrans.length > 0) {
                    text += `ITA√ö: ${formatCurrency(totalItau)}\n`;
                    itauTrans.forEach(t => text += `- ${t.detail}: ${formatCurrency(t.amount)}\n`);
                    text += `\n`;
                }
                if (bchTrans.length > 0) {
                    text += `BCH: ${formatCurrency(totalBch)}\n`;
                    bchTrans.forEach(t => text += `- ${t.detail}: ${formatCurrency(t.amount)}\n`);
                    text += `\n`;
                }
                if (tenpoTrans.length > 0) {
                    text += `TENPO: ${formatCurrency(totalTenpo)}\n`;
                    tenpoTrans.forEach(t => text += `- ${t.detail}: ${formatCurrency(t.amount)}\n`);
                    text += `\n`;
                }
                text += `----------------------------\n`;
                text += `TOTAL: ${formatCurrency(totalItau + totalBch + totalTenpo)}`;

                if (navigator.share) {
                    await navigator.share({
                        text: text,
                        title: `Reporte ${getNextMonthYear()}`
                    });
                }
            };

            const transactionsThisMonth = transactions.filter(t => {
                const tDate = new Date(t.date);
                const now = new Date();
                return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
            });

            const itauTrans = transactionsThisMonth.filter(t => t.account === 'Ita√∫');
            const bchTrans = transactionsThisMonth.filter(t => t.account === 'BCH');
            const tenpoTrans = transactionsThisMonth.filter(t => t.account === 'Tenpo');
            const totalItau = itauTrans.reduce((acc, c) => acc + c.amount, 0);
            const totalBch = bchTrans.reduce((acc, c) => acc + c.amount, 0);
            const totalTenpo = tenpoTrans.reduce((acc, c) => acc + c.amount, 0);

            if (loading) return <div className="h-screen flex items-center justify-center font-bold text-slate-400">Sincronizando...</div>;

            return (
                <div className="h-screen flex flex-col bg-slate-50">
                    <div className="pt-14 pb-4 px-6 bg-white/80 backdrop-blur-md sticky top-0 z-10 border-b flex justify-between items-center">
                        <h1 className="text-2xl font-bold text-slate-800">
                            {activeTab === 'settlement' ? 'Liquidaci√≥n' : activeTab === 'debt' ? 'Deuda Global' : 'Cuotas Fijas'}
                        </h1>
                        <button onClick={() => setShowReport(true)} className="text-blue-600 font-semibold ios-btn">Reporte</button>
                    </div>

                    <div className="flex-1 overflow-y-auto no-scrollbar pb-32 px-4 pt-6">
                        {activeTab === 'settlement' && (
                            <div className="space-y-6">
                                <div className="bg-white p-5 rounded-3xl shadow-sm border">
                                    <input type="number" inputMode="numeric" value={amount} onChange={(e) => setAmount(e.target.value)} className="ios-input mb-4" placeholder="Monto $"/>
                                    <div className="grid grid-cols-3 gap-3 mb-4">
                                        {['Ita√∫', 'BCH', 'Tenpo'].map(b => (
                                            <button key={b} onClick={() => setAccount(b)} className={`py-3 rounded-xl text-xs font-bold ${account === b ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-500'}`}>{b}</button>
                                        ))}
                                    </div>
                                    <input type="text" value={detail} onChange={(e) => setDetail(e.target.value)} className="ios-input mb-4" placeholder="Detalle"/>
                                    <button onClick={addTransaction} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold ios-btn">Agregar</button>
                                </div>
                                <div className="bg-white p-5 rounded-3xl shadow-sm border">
                                    <h3 className="font-bold mb-4">Pagos del mes</h3>
                                    {transactionsThisMonth.filter(t => t.type === 'normal').sort((a,b)=>b.id-a.id).map(t => (
                                        <div key={t.id} className="flex justify-between items-center border-b py-3">
                                            <div><p className="font-medium">{t.detail}</p><p className="text-[10px] uppercase text-slate-400 font-bold">{t.account}</p></div>
                                            <div className="flex items-center gap-3"><span className="font-bold">{formatCurrency(t.amount)}</span><button onClick={()=>deleteTransaction(t.id)} className="text-slate-300"><TrashIcon/></button></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'debt' && (
                            <div className="space-y-6">
                                <div className="bg-gradient-to-br from-indigo-600 to-blue-700 p-6 rounded-3xl text-white">
                                    <p className="text-xs opacity-80">Saldo Pendiente</p>
                                    <h2 className="text-4xl font-bold mb-4">{formatCurrency(debtBalance)}</h2>
                                    <button onClick={() => setIsSettingDebt(!isSettingDebt)} className="text-[10px] bg-white/20 px-3 py-1 rounded-full uppercase font-bold tracking-wider">Ajustar Saldo Total</button>
                                </div>
                                {isSettingDebt && (
                                    <div className="bg-white p-5 rounded-3xl border">
                                        <input type="number" value={initialDebtInput} onChange={(e) => setInitialDebtInput(e.target.value)} className="ios-input mb-4" placeholder="Nuevo saldo total"/>
                                        <button onClick={() => { setDebtBalance(parseInt(initialDebtInput)); sync({debtBalance: parseInt(initialDebtInput)}); setIsSettingDebt(false); }} className="w-full bg-indigo-600 text-white py-3 rounded-2xl font-bold">Guardar</button>
                                    </div>
                                )}
                                <div className="bg-white p-5 rounded-3xl border">
                                    <h3 className="font-bold mb-4">Nuevo Abono (en BCH)</h3>
                                    <input type="number" value={debtPayment} onChange={(e) => setDebtPayment(e.target.value)} className="ios-input mb-4" placeholder="Monto abono"/>
                                    <input type="text" value={debtDetail} onChange={(e) => setDebtDetail(e.target.value)} className="ios-input mb-4" placeholder="Ej: Abono Marzo"/>
                                    <button onClick={payDebt} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold">Registrar Abono</button>
                                </div>
                                <div className="bg-white p-5 rounded-3xl border">
                                    <h3 className="font-bold mb-4">Historial de Abonos</h3>
                                    {transactionsThisMonth.filter(t => t.type === 'debt').map(t => (
                                        <div key={t.id} className="flex justify-between items-center border-b py-3">
                                            <div><p className="font-medium">{t.detail}</p><p className="text-[10px] text-indigo-500 font-bold">BCH</p></div>
                                            <div className="flex items-center gap-3"><span className="font-bold">{formatCurrency(t.amount)}</span><button onClick={()=>deleteTransaction(t.id)} className="text-slate-300"><TrashIcon/></button></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'installments' && (
                            <div className="space-y-6">
                                <div className="bg-white p-5 rounded-3xl border">
                                    <h3 className="font-bold mb-4">Nueva Deuda</h3>
                                    <input type="number" value={instAmount} onChange={(e) => setInstAmount(e.target.value)} className="ios-input mb-4" placeholder="Monto cuota"/>
                                    <div className="flex gap-2 mb-4">
                                        <input type="number" value={instTotal} onChange={(e) => setInstTotal(e.target.value)} className="ios-input w-1/2" placeholder="Total cuotas"/>
                                        <input type="number" value={instPaid} onChange={(e) => setInstPaid(e.target.value)} className="ios-input w-1/2" placeholder="Ya pagadas"/>
                                    </div>
                                    <input type="text" value={instDetail} onChange={(e) => setInstDetail(e.target.value)} className="ios-input mb-4" placeholder="Detalle"/>
                                    <button onClick={() => {
                                        const newI = { id: Date.now(), amount: parseInt(instAmount), detail: instDetail, totalQuotas: parseInt(instTotal), currentQuota: parseInt(instPaid||0), account: 'Ita√∫', active: true };
                                        const newList = [...installments, newI];
                                        setInstallments(newList);
                                        sync({ installments: newList });
                                        setInstAmount(''); setInstDetail(''); setInstTotal(''); setInstPaid('');
                                    }} className="w-full bg-teal-600 text-white py-4 rounded-2xl font-bold">Guardar</button>
                                </div>
                                {installments.map(item => {
                                    const isPaidOff = item.currentQuota >= item.totalQuotas;
                                    return (
                                        <div key={item.id} className={`bg-white p-5 rounded-3xl border transition-all ${isPaidOff ? 'border-green-200 bg-green-50/30' : ''}`}>
                                            <div className="flex justify-between mb-2">
                                                <div><h4 className="font-bold">{item.detail}</h4><p className="text-[10px] text-slate-400 font-bold uppercase">{item.account}</p></div>
                                                <div className="text-right">
                                                    <p className="font-bold">{formatCurrency(item.amount)}</p>
                                                    <p className="text-[10px] text-slate-500 font-bold">{item.currentQuota} de {item.totalQuotas} cuotas</p>
                                                </div>
                                            </div>
                                            <div className="w-full bg-slate-100 h-2 rounded-full mb-4">
                                                <div className={`h-2 rounded-full transition-all ${isPaidOff ? 'bg-green-500' : 'bg-teal-500'}`} style={{width: `${(item.currentQuota/item.totalQuotas)*100}%`}}></div>
                                            </div>
                                            <div className="flex gap-2">
                                                {!isPaidOff ? (
                                                    <button onClick={() => payInstallmentQuota(item.id)} className="flex-1 bg-slate-800 text-white py-3 rounded-xl text-sm font-bold ios-btn">Pagar Cuota {item.currentQuota + 1}</button>
                                                ) : (
                                                    <div className="flex-1 bg-green-100 text-green-700 py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2"><CheckIcon/> DEUDA PAGADA</div>
                                                )}
                                                <button onClick={() => deleteInstallmentDebt(item.id)} className="px-4 bg-red-50 text-red-500 rounded-xl ios-btn"><TrashIcon/></button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t pb-8 pt-3 flex justify-around">
                        <button onClick={() => setActiveTab('settlement')} className={`flex flex-col items-center ${activeTab === 'settlement' ? 'text-blue-600' : 'text-slate-400'}`}><CreditCardIcon/><span className="text-[10px] font-bold">Liquidaci√≥n</span></button>
                        <button onClick={() => setActiveTab('installments')} className={`flex flex-col items-center ${activeTab === 'installments' ? 'text-teal-600' : 'text-slate-400'}`}><CalendarIcon/><span className="text-[10px] font-bold">Cuotas</span></button>
                        <button onClick={() => setActiveTab('debt')} className={`flex flex-col items-center ${activeTab === 'debt' ? 'text-indigo-600' : 'text-slate-400'}`}><WalletIcon/><span className="text-[10px] font-bold">Deuda</span></button>
                    </div>

                    {showReport && (
                        <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-[40px] p-8 shadow-2xl flex flex-col overflow-hidden">
                                
                                <div id="report-container" className="bg-white p-6">
                                    <div className="flex justify-between mb-6">
                                        <h3 className="font-bold text-lg text-slate-800">{getNextMonthYear()}</h3>
                                    </div>
                
                                    <div className="space-y-6 text-sm">
                                        {/* ITAU */}
                                        <section>
                                            <div className="flex justify-between items-end border-b-2 border-orange-500 pb-1 mb-2">
                                                <p className="text-xs font-black text-orange-500 uppercase tracking-widest">Ita√∫</p>
                                                <p className="text-sm font-black text-orange-600">{formatCurrency(totalItau)}</p>
                                            </div>
                                            {itauTrans.map(t=>(<div key={t.id} className="flex justify-between text-xs mb-1 text-slate-600"><span>- {t.detail}</span><span>{formatCurrency(t.amount)}</span></div>))}
                                        </section>
                                        
                                        {/* BCH */}
                                        <section>
                                            <div className="flex justify-between items-end border-b-2 border-blue-600 pb-1 mb-2">
                                                <p className="text-xs font-black text-blue-600 uppercase tracking-widest">BCH</p>
                                                <p className="text-sm font-black text-blue-700">{formatCurrency(totalBch)}</p>
                                            </div>
                                            {bchTrans.map(t=>(<div key={t.id} className="flex justify-between text-xs mb-1 text-slate-600"><span>- {t.detail}</span><span>{formatCurrency(t.amount)}</span></div>))}
                                        </section>
                                        
                                        {/* TENPO */}
                                        {totalTenpo > 0 && (
                                            <section>
                                                <div className="flex justify-between items-end border-b-2 border-purple-600 pb-1 mb-2">
                                                    <p className="text-xs font-black text-purple-600 uppercase tracking-widest">Tenpo</p>
                                                    <p className="text-sm font-black text-purple-700">{formatCurrency(totalTenpo)}</p>
                                                </div>
                                                {tenpoTrans.map(t=>(<div key={t.id} className="flex justify-between text-xs mb-1 text-slate-600"><span>- {t.detail}</span><span>{formatCurrency(t.amount)}</span></div>))}
                                            </section>
                                        )}

                                        <div className="pt-4 border-t-2 border-slate-900 flex justify-between items-center">
                                            <span className="font-black text-lg uppercase">Total</span>
                                            <span className="text-lg font-black text-slate-900">{formatCurrency(totalItau + totalBch + totalTenpo)}</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="px-6 pb-8 space-y-4">
                                    <button onClick={shareAsImage} className="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold ios-btn shadow-lg shadow-blue-100">
                                        Compartir Imagen
                                    </button>
                                    
                                    <div className="flex flex-col items-center gap-4 mt-2">
                                        <button onClick={shareAsText} className="text-slate-400 text-xs font-bold uppercase tracking-widest">
                                            Compartir como Texto
                                        </button>
                                        
                                        <button onClick={()=>setShowReport(false)} className="bg-slate-100 text-slate-500 w-12 h-12 rounded-full flex items-center justify-center">
                                            <XIcon/>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
